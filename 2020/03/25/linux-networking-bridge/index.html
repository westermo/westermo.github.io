<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>Linux Networking Bridge</title>
  <meta name="description" content="This is the second post in a series of posts showing how to set up networking in Linux using low-level tools. It’s time to talk about bridging (switching) and VLANs.">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://westermo.github.io/2020/03/25/linux-networking-bridge/">
  
  
  <link rel="alternate" type="application/rss+xml" title="Westermo Labs" href="https://westermo.github.io/feed.xml">

  

  
  <meta property="og:title" content="Linux Networking Bridge">
  <meta property="og:site_name" content="Westermo Labs">
  <meta property="og:url" content="https://westermo.github.io/2020/03/25/linux-networking-bridge/">
  <meta property="og:description" content="This is the second post in a series of posts showing how to set up networking in Linux using low-level tools. It’s time to talk about bridging (switching) and VLANs.">
  
  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:title" content="Linux Networking Bridge">
  <meta name="twitter:description" content="This is the second post in a series of posts showing how to set up networking in Linux using low-level tools. It’s time to talk about bridging (switching) and VLANs.">
  
  

  <link rel="dns-prefetch" href="https://fonts.gstatic.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Bitter:ital,wght@0,400;0,700;1,400&amp;display=swap" rel="stylesheet">

  

</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Westermo Labs</a>

    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/">About</a>
      
        
        <a class="page-link" href="/archives/">Archives</a>
      
        
        <a class="page-link" href="https://github.com/westermo/">GitHub</a>
      
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">Linux Networking Bridge</h1>
    
    <p class="post-meta"><time datetime="2020-03-25T00:20:42+01:00" itemprop="datePublished">Mar 25, 2020</time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Joachim Wiberg</span></span>

 •
  
    
    
      
    
      
        <a href="/tags/howto/">howto</a>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  

</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>This is the second post in a series of posts showing how to set up
networking in Linux using low-level tools.</p>

<p>It’s time to talk about bridging (switching) and VLANs.</p>

<!-- more -->

<h2>Bridging, or Switching</h2>

<p>The <a href="/2020/03/24/linux-networking-intro/">fist post</a>
introduced LANs and broadcast domains.  An Ethernet bridge, or more
commonly, a switch, connects multiple networks segments into a common
broadcast domain.  If you are interested in this, see <a href="https://en.wikipedia.org/wiki/Bridging_(networking)">the Wikipedia
page on bridging</a>
for details.</p>

<p>In Linux we can create a software defined switch by adding multiple
network interfaces (NICs) to a PC and then connect them to the bridge
module.  In this setup these interfaces are called ports, and we don’t
set IP addresses on them.  Instead, we do that on the bridge, and on
interfaces on top of the bridge.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                    br0          &lt;---- bridge interface
                 ____|____
                |#_#_#_#_#|      &lt;---- bridge
                /  |   |  \
            eth0 eth1 eth2 eth3  &lt;---- ports
</code></pre></div></div>

<h2>Virtual LANs, VLANs</h2>

<p>To kick things up a notch we need to introduce one more concept before
moving on – <a href="https://en.wikipedia.org/wiki/IEEE_802.1Q">VLANs</a>!</p>

<p>A VLAN, or <em>virtual</em> LAN, is one of the true corner stones in most
network setups, and as such is really deserves a blog post of its own.</p>

<p>However, for the purpose of this post, consider VLANs a way for us to
<em>group ports</em> in separate broadcast domains.  I.e., isolate certain end
devices from each other; e.g., an office network from a process control
network.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                      br0
                 ______|______
                |#_#_#_#_#_#_#|
                /  |   :  |    \ 
            eth0 eth1  :  eth2 eth3
                       :
              VLAN 1   :    VLAN 2
</code></pre></div></div>

<p>Here we have configured the bridge (switch) to assign ports eth0 and
eth1 to VLAN 1, and eth2 and eth3 to VLAN 2.  Ports in each VLAN can
only communicate with each other, the bridge ensures a true separation
between both VLANs.</p>

<p>If a device on port eth0 (member of VLAN 1) wants to communicate with a
device on port eth3 (member of VLAN 2) it must be routed somehow.  For
this to work we must either connect a router to ports eth1 and eth2, or
let interface br0 be a member of both VLANs.</p>

<blockquote>
  <p>A port that is member of more than one VLAN is often referred to as a
<em>trunk port</em>, and a port facing an end device is called <em>access port</em>.</p>
</blockquote>

<p>Port VLAN memberships can be <em>tagged</em> or <em>untagged</em>.  A tagged port is
usually a trunk port, and an untagged port is usually an access port.
There are always exceptions to these rules, but for most cases this is a
good starting point.</p>

<p>To route traffic between VLAN 1 and VLAN 2 we create the following
setup (it’s starting to look a bit crazy now):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>IP: 192.168.1.1                     IP: 192.168.2.1
                  br0.1     br0.2
                       \   /
                        br0
                   ______|______
                  |#_#_#_#_#_#_#|
                  /  |   :  |    \ 
              eth0 eth1  :  eth2 eth3
                         :
                VLAN 1   :    VLAN 2
</code></pre></div></div>

<p>Since <code class="language-plaintext highlighter-rouge">br0</code> now is a tagged member of both VLANs we need to create VLAN
interfaces on top of it to be able to set IP addresses.  These are the
gateway addresses each end device will use in their IP network setup.</p>

<p>That is basically it, remember to enable IP forwarding … now let’s get
hands-on with the command line!</p>

<blockquote>
  <p>In the next section we use the names <code class="language-plaintext highlighter-rouge">vlan1</code> and <code class="language-plaintext highlighter-rouge">vlan2</code> instead of
<code class="language-plaintext highlighter-rouge">br0.1</code> and <code class="language-plaintext highlighter-rouge">br0.2</code>, respectively.  The naming is not only create
confusion, but to a) show that any name can be used, and b) simplify
and follow the terminology used in Westermo WeOS.</p>
</blockquote>

<h2>Creating a Bridge in Linux</h2>

<p>There are actually two variants of the standard bridge in mainline
Linux; old-style and new-style.  The latter, which we will focus on in
this blog post, has native support for VLAN filtering.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ip link add br0 type bridge
# ip link set br0 type bridge vlan_filtering 1
</code></pre></div></div>

<blockquote>
  <p><strong>Note:</strong> recent versions of Debian based systems, like Ubuntu, have
enabled bridge firewalling by default.  This may completely disable
all or some forwarding of traffic on bridges.  Causing a lot of head
scratching!  See <a href="/2021/06/24/bridge-forwarding-problem/">Bridge Forwarding Problem</a> for a fix!</p>
</blockquote>

<p>Now, add a couple of ports to the bridge:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ip link set eth0 master br0
# ip link set eth1 master br0
</code></pre></div></div>

<p>To see the ports we use the <a href="http://man7.org/linux/man-pages/man8/bridge.8.html">bridge(8)</a> command, which is also part
of the iproute2 tool suite:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># bridge link
2: eth0: &lt;BROADCAST,MULTICAST&gt; mtu 1500 master br0 state disabled priority 32 cost 100 
4: eth1: &lt;BROADCAST,MULTICAST&gt; mtu 1500 master br0 state disabled priority 32 cost 4 
</code></pre></div></div>

<p>To see the default VLAN assignments of ports:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># bridge vlan show
port    vlan ids
eth0     1 PVID Egress Untagged
eth1     1 PVID Egress Untagged
br0      1 PVID Egress Untagged
</code></pre></div></div>

<p>So these ports look OK, the default VLAN ID assigned to ports is 1.
Lets add the other two, but now we need to tell the bridge to use VLAN
ID 2 instead.  We also set the <code class="language-plaintext highlighter-rouge">pvid</code> and <code class="language-plaintext highlighter-rouge">untagged</code> flags since we
want to treat these ports as access ports (untagged), and assign their
default VLAN (ID 2) on ingress (pvid).  Remember to remove from their
default VLAN (ID 1) as well:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ip link set eth2 master br0
# ip link set eth3 master br0
# bridge vlan add vid 2 dev eth2 pvid untagged
# bridge vlan add vid 2 dev eth3 pvid untagged
# bridge vlan del vid 1 dev eth2
# bridge vlan del vid 1 dev eth3
</code></pre></div></div>

<p>To see static and learned MAC addresses (c.f. the <code class="language-plaintext highlighter-rouge">arp</code> command):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># bridge fdb show
00:80:e1:42:55:a3 dev eth0 vlan 1 master br0 permanent
00:80:e1:42:55:a3 dev eth0 master br0 permanent
33:33:00:00:00:01 dev eth0 self permanent
00:e0:4c:68:03:06 dev eth1 vlan 1 master br0 permanent
00:e0:4c:68:03:06 dev eth1 master br0 permanent
33:33:00:00:00:01 dev eth1 self permanent
...
33:33:00:00:00:01 dev br0 self permanent
</code></pre></div></div>

<p>In our use-case we have two different VLANs, so we need to change the
bridge port itself to be a <em>tagged</em> VLAN member, otherwise we cannot
distinguish between frames on different VLANs and thus cannot set up
our VLAN interfaces on top, like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    vlan1     vlan2      Layer-3 :: IP Networking
         \   /           -------------------------------
          br0
     ______|_______      Layer-2 :: Switching
    [#_#_#_#_#_#_#] 
    /  |   :  |    \     -------------------------------
eth0 eth1  : eth2 eth3   Layer-1 :: Link layer
           :
  VLAN 1   :    VLAN 2
</code></pre></div></div>

<p>Let’s change br0 to be a tagged member of VLAN 1 and 2:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># bridge vlan add vid 1 dev br0 self
# bridge vlan add vid 2 dev br0 self
# bridge vlan show
port    vlan ids
eth0     1 PVID Egress Untagged
eth1     1 PVID Egress Untagged
eth2     2 PVID Egress Untagged
eth3     2 PVID Egress Untagged
br0      1
         2
</code></pre></div></div>

<p>Now we add our VLAN interface on top of <code class="language-plaintext highlighter-rouge">br0</code> so we can communicate with
the outside world.  Some prefer naming VLAN interfaces <code class="language-plaintext highlighter-rouge">br0.1</code>, but here
we use <code class="language-plaintext highlighter-rouge">vlan1</code> since we will only use one bridge:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ip link add name vlan1 link br0 type vlan id 1
# ip addr add 192.168.1.1/24 dev vlan1
# ip link add name vlan2 link br0 type vlan id 2
# ip addr add 192.168.2.1/24 dev vlan2
</code></pre></div></div>

<p>Bring everything up by taking up the bridge and its ports:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ip link set eth0 up
# ip link set eth1 up
# ip link set eth2 up
# ip link set eth3 up
# ip link set br0 up
# ip link set vlan1 up
# ip link set vlan2 up
</code></pre></div></div>

<p>This is a good time to have a look at the available interfaces:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ip -brief link show
lo        UNKNOWN  00:00:00:00:00:00 &lt;LOOPBACK,UP,LOWER_UP&gt;
eth0      UP       00:80:e1:42:55:a0 &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt;
eth1      UP       00:80:e1:42:55:a1 &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;
eth2      UP       00:80:e1:42:55:a2 &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt;
eth3      UP       00:80:e1:42:55:a3 &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;
br0       UP       00:80:e1:42:55:a0 &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;
vlan1@br0 UP       00:80:e1:42:55:a0 &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; 
vlan2@br0 UP       00:80:e1:42:55:a0 &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;
</code></pre></div></div>

<p>As you can see, the <code class="language-plaintext highlighter-rouge">vlan1</code> interface is created on top of <code class="language-plaintext highlighter-rouge">br0</code>,
<code class="language-plaintext highlighter-rouge">vlan1@br0</code>.  The addresses of all interfaces can be inspected with the
<code class="language-plaintext highlighter-rouge">ip address</code> command.  For a quick overview, use the <code class="language-plaintext highlighter-rouge">-brief</code> switch:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ip -br addr show
lo               UNKNOWN        127.0.0.1/8
eth0             UP             
eth1             UP             
eth2             UP             
eth3             UP             
br0              UP             
vlan1@br0        UP             192.168.1.1/24
vlan2@br0        UP             192.168.2.1/24
</code></pre></div></div>

<p>Here we have automatically configured IPv6 addresses on eth1 and br0,
this should be disabled since IP addresses in a our bridge setup should
only be set on the VLAN interfaces.</p>

<h2>Summary and More</h2>

<p>In this post we covered the theory of Ethernet bridges and VLANs, and
then proceeded to provide an example of how to set this up a single
bridge up in Linux.</p>

<p>But wait, what if we want to connect two separate bridges, on two PCs,
with multiple VLANs on each?  Let’s extend the image used previously,
and add a syntax for denoting VLAN memberships: <em>1U</em> means untagged
member of VLAN 1, <em>2U</em> means untagged in VLAN 2, and <em>1T</em> means tagged
member of VLAN 1, etc.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  vlan1     vlan2              vlan1     vlan2
       \   /                        \   /
        br0  1T,2T                   br0  1T,2T,3T
     ____|____                    ____|__________
    [#_#_#_#_#]                  [#_#_#_#_#_#_#_#]
    /  |      \                  /  |   |   \    \
eth2  eth1     eth0----------eth0 eth1 eth2  eth3 eth4
 2U    1U             1T,2T        1U   2U    3U   3U
</code></pre></div></div>

<p>The image shows two devices with one bridge each.  The right-hand bridge
has more ports and VLANs, but they are interconnected using port eth0 on
each bridge.  This shared link, VLAN “trunk” (see above), serves as the
backbone for this network.</p>

<blockquote>
  <p>Notice how VLAN 3 only exists on the right-hand bridge, both bridges
filter traffic going out and coming in on the trunk from port eth0, to
prevent VLAN 3 from reaching beyond its boundary (port eth3 and eth4).</p>
</blockquote>

<h2>EOF</h2>

<p>Future posts will cover how the Linux bridge can be used with single
board computers that support switching in hardware, i.e., offloading of
the otherwise CPU intensive parts.</p>

<p>Feel free to contact Westermo for more information, help designing your
network, and hands on training on our products.</p>

<p>Visit <a href="https://www.westermo.com">https://www.westermo.com</a></p>


  </div>

  

</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      

&copy; Westermo Engineers - Powered by <a href="https://jekyllrb.com">Jekyll</a> &amp; <a href="https://github.com/yous/whiteglass">whiteglass</a> - Subscribe via <a href="https://westermo.github.io/feed.xml">RSS</a>

    </p>

  </div>

</footer>


  </body>

</html>
